---
title: ""
runtime: shiny
output:
  html_document:
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
---


```{r, echo=FALSE,message=FALSE, warning=FALSE}

# packages
library(shiny)
library(deSolve)
library(tidyverse)
library(openxlsx)
library(shinythemes)
library(shinyjs)
library(DT)

col_a  <- c("#FBDB82FF","#24719BFF","#6A1639FF")

ui <- fluidPage(useShinyjs(), theme = shinytheme("flatly"), withMathJax(),
                tags$head(tags$style(HTML("
  label { font-size: 14px; }
  .form-control { font-size: 12px; }
  .btn { font-size: 14px; }
  h2 { font-size: 14px; }"))),
                sidebarLayout(
                  sidebarPanel(width = 4,
                               fluidRow(
                                 column(3,
                                        h2("Population (per age group)"),
                                        numericInput("N_young", "0-19", 20000),
                                        numericInput("N_adult", "20-64", 60000),
                                        numericInput("N_elderly", "65+", 20000),
                                        
                                        h2("Parameter Hospital"),
                                        numericInput("Hosp_day", "Hospital days", 5),
                                        numericInput("ICU_day", "ICU days", 10),
                                        numericInput("ICU_prop", "ICU percentage", 15),
                    
                                         
                                 ),
                                 column(3,
                                        h2("Intervention periods (days)"),
                                        numericInput("period1", "Period 1", 25),
                                        numericInput("period2", "Period 2", 50),
                                        numericInput("period3", "Period 3", 100),
                                        h2("Intervention reduction factors"),
                                        numericInput("int1", "Period 1", 0.2),
                                        numericInput("int2", "Period 2", 0.5),
                                        numericInput("int3", "Period 3", 0.7)
                                 ),
                                 column(3,
                                        h2("Vaccination periods (days)"),
                                        numericInput("pervac1", "Period 1", 100),
                                        numericInput("pervac2", "Period 2", 150),
                                        numericInput("pervac3", "Period 3", 200)
                                 ),
                                 column(3,
                                        h2("Vaccination rates (daily) 0-19 Young"),
                                        numericInput("vacc_young1", "Period 1", 0),
                                        numericInput("vacc_young2", "Period 2", 0),
                                        numericInput("vacc_young3", "Period 3", 0),
                                        h2("Vaccination rates (daily) 20-64 Adult"),
                                        numericInput("vacc_adult1", "Period 1", 0),
                                        numericInput("vacc_adult2", "Period 2", 0),
                                        numericInput("vacc_adult3", "Period 3", 0),
                                        h2("Vaccination rates (daily) 65 + Elderly"),
                                        numericInput("vacc_elderly1", "Period 1", 0),
                                        numericInput("vacc_elderly2", "Period 2", 0),
                                        numericInput("vacc_elderly3", "Period 3", 0),
                                        actionButton("run", "Run Simulation")
                                 )
                               )
                  ),
                  mainPanel(
                    plotOutput("seirPlot", height = "600px"),
                    dataTableOutput('TableRed'),
                    downloadButton('downloadData', 'Download all data')
                  )
                )
)

server <- function(input, output) {
  
  sim_data <- eventReactive(input$run, {
    age_groups <- c("young","adult","elderly")
    
    contact_matrix <- matrix(c(
      8,4,1,
      3,6,2,
      1,2,3
    ), nrow=3, byrow=TRUE)
    rownames(contact_matrix) <- age_groups
    colnames(contact_matrix) <- age_groups
    
    # Parameters
    R0_vec <- c(young = 2.5, adult = 3, elderly = 3.5)
    CFR_vec <- c(young = 0.0001, adult = 0.0003, elderly = 0.02)
    p_hosp_vec <- c(young = 0.01, adult = 0.03, elderly = 0.05)
    p_die_hosp_vec <- c(young = 0.02, adult = 0.06, elderly = 0.15) # fraction of hospitalized who die 
    p_die_icu_vec <- c(young = 0.10, adult = 0.25, elderly = 0.5) # fraction of hospitalized who die
    sigma <- 1/2
    gamma <- 1/5
    # Ht <- 5    # avg non-ICU hospital stay (days)
    # Ct <- 10   # avg ICU stay (days)
    # p_icu <- 0.15  # fraction of hospitalized who go to ICU (at admission)
    # 
    
    N_age <- c(young=input$N_young, adult=input$N_adult, elderly=input$N_elderly)
    beta_vec <- R0_vec * gamma / rowSums(contact_matrix)
    
    # Initial state (S,E,I,H,C,R,D per age)
    init_state <- c(
      S_young=as.integer(N_age["young"])-1, E_young=0, I_young=1, H_young=0, C_young=0, R_young=0, D_young=0,
      S_adult=as.integer(N_age["adult"]), E_adult=0, I_adult=0, H_adult=0, C_adult=0, R_adult=0, D_adult=0,
      S_elderly=as.integer(N_age["elderly"]), E_elderly=0, I_elderly=0, H_elderly=0, C_elderly=0, R_elderly=0, D_elderly=0
    )
    
    get_intervention_factor <- function(time) {
      if (time < input$period1) 1.0
      else if (time < input$period2) input$int1
      else if (time < input$period3) input$int2
      else input$int3
    }
    
    v1 <- as.integer(c(input$vacc_young1,input$vacc_adult1,input$vacc_elderly1))
    v2 <- as.integer(c(input$vacc_young2,input$vacc_adult2,input$vacc_elderly2))
    v3 <- as.integer(c(input$vacc_young3,input$vacc_adult3,input$vacc_elderly3))
    
    get_vaccination_rate <- function(time) {
      if (time >= input$period1 & time < input$period2) c(young=v1[1], adult=v1[2], elderly=v1[3])
      else if (time >= input$period2 & time < input$period3) c(young=v2[1], adult=v2[2], elderly=v2[3])
      else if (time >= input$period3) c(young=v3[1], adult=v3[2], elderly=v3[3])
      else c(young=0, adult=0, elderly=0)
    }
    
    seird_model_age <- function(time, state, parameters) {
      with(as.list(state), {
        d_state <- numeric(length(state)); names(d_state) <- names(state)
        
        I_vec <- sapply(age_groups, function(age) state[paste0("I_", age)])
        contact_matrix_eff <- contact_matrix * get_intervention_factor(time)
        lambda <- sapply(1:3, function(j) sum(contact_matrix_eff[j, ] * I_vec / N_age))
        vac_rates <- get_vaccination_rate(time)
        
        for (i in 1:3) {
          age <- age_groups[i]
          S <- state[paste0("S_", age)]
          E <- state[paste0("E_", age)]
          I <- state[paste0("I_", age)]
          H <- state[paste0("H_", age)]
          C <- state[paste0("C_", age)]
          
          CFR <- CFR_vec[age]
          beta <- beta_vec[age]
          p_hosp <- p_hosp_vec[age]
          p_die_hosp <- p_die_hosp_vec[age]
          p_die_icu <- p_die_icu_vec[age]
          
          vac <- min(S, vac_rates[age])
    
    
          # 
          mu_h <- p_die_hosp / input$Hosp_day
          rho_h <- (1 - p_die_hosp) / input$Hosp_day

          mu_c <- p_die_icu  / input$ICU_day
          rho_c <- (1 - p_die_icu)/ input$ICU_day
          
          p_icu <- input$ICU_prop/100
          p_icu_safe <- ifelse(p_icu >= 1, 0.9999, p_icu)
          phi <- p_icu_safe / (1 - p_icu_safe) * (rho_h + mu_h)
          
          # phi <- p_icu / (1 - p_icu) * (rho_h + mu_h) 
          #     
          # ODEs
          dS <- -beta * S * lambda[i] - vac
          dE <-  beta * S * lambda[i] - sigma * E
          dI <-  sigma * E - gamma * I
          # dH <- p_hosp * gamma * I - (rho_h + mu_h) * H
          # dC <- p_icu * p_hosp * gamma * I -  (rho_c + mu_c)* C
          
          dH <- p_hosp * gamma * I - (rho_h + mu_h + phi) * H  # all hospitalizations
          dC <- phi * H - (rho_c + mu_c) * C                         # ICU subset of H

# phi = rate at which H patients are transferred to ICU to achieve exactly p_icu fraction

          
          # Recovered and Deaths: accumulate from compartment outflows and vaccination
          dR <- (1 - p_hosp) * gamma * I + rho_h * H + rho_c * C + vac
          dD <- CFR * gamma * I + mu_h * H + mu_c * C
          
          d_state[paste0("S_", age)] <- dS
          d_state[paste0("E_", age)] <- dE
          d_state[paste0("I_", age)] <- dI
          d_state[paste0("H_", age)] <- dH
          d_state[paste0("C_", age)] <- dC
          d_state[paste0("R_", age)] <- dR
          d_state[paste0("D_", age)] <- dD
        }
        return(list(d_state))
      })
    }
    
    time <- seq(0, 300, by = 1)
    out <- as.data.frame(ode(y = init_state, times = time, func = seird_model_age, parms = NULL))
    
    # Prepare outputs
    dt_d <- out[, c(1, grep("^D_", names(out)))] %>% gather(., comp, prop, -time)
    dt_i <- out[, c(1, grep("^I_", names(out)))] %>% gather(., comp, prop, -time)
    dt_h <- out[, c(1, grep("^H_", names(out)))] %>% gather(., comp, prop, -time)
    dt_hv <- dt_h$prop
    dt_c <- out[, c(1, grep("^C_", names(out)))] %>% gather(., comp, prop, -time)
    dt_cv <- dt_c$prop
    dt_htv <- dt_h$prop + dt_c$prop
    dt_h <- dt_h %>%
      select(time,comp) %>%
      mutate(prop = dt_htv )
    dt_pop <- data.frame(N_age) %>% mutate(age = row.names(.)) %>% rename(pop = N_age)
    
    dt <- bind_rows(dt_d, dt_h, dt_i, dt_c) %>%
      mutate(age = str_sub(comp, 3),
             fac = str_sub(comp, 1, 1),
             fac = case_when(
               fac == "D" ~ "Deceased",
               fac == "I" ~ "Infected",
               fac == "H" ~ "Hospitalised",
               fac == "C" ~ "ICU"
             ),
             fac = factor(fac, levels = c("Infected", "Hospitalised", "ICU", "Deceased"))
      ) %>%
      left_join(dt_pop) %>%
      mutate(mx = prop / pop * 100000)
    
    dts <- dt %>%
      select(Day = time, Age = age, Pop = pop, Event = fac, Absolute = prop, Relative = mx) %>%
      mutate(Absolute = round(Absolute), Relative = round(Relative, 2))
    
    return(dts)
  })
  
  output$seirPlot <- renderPlot({
    df <- sim_data()
    df$Age <- factor(df$Age, levels = c("young", "adult", "elderly"))
    
    ggplot(df, aes(x = Day)) +
      facet_wrap(~ Event, ncol = 4, scales = "free_y") +
      geom_line(aes(y = Absolute, color = Age), lwd = 1.5) +
      labs(x = "Days", y = "Individuals") +
      scale_color_manual("", breaks = c("young", "adult", "elderly"),
                         labels = c("0-19", "20-64", "65+"),
                         values = col_a) +
      theme_bw() +
      theme(strip.text = element_text(size = 14),
            axis.text = element_text(size = 12),
            axis.title = element_text(size = 14),
            legend.position = "bottom")
  })
  
  dtta <- reactive({
    sim_data() %>% filter(Day %in% c(25,50,100,200))
  })
  
  output$TableRed <- renderDataTable({
    datatable(dtta(), options = list(pageLength = 10, lengthChange = FALSE))
  })
  
  output$downloadData <- downloadHandler(
    filename = function() { paste("simulation_data", "xlsx", sep = ".") },
    content = function(file) { write.xlsx(sim_data(), file, row.names = FALSE) }
  )
}

shinyApp(ui = ui, server = server, options = list(height = 1000, width = 2000))
```

