---
title: ""
runtime: shiny
output:
  html_document:
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
---


```{r, echo=FALSE,message=FALSE, warning=FALSE}

library(shiny)
library(deSolve)
library(tidyverse)
library(openxlsx)
library(shinythemes)
library(shinyjs)
library(DT)

col_a  <- c("#FBDB82FF","#24719BFF","#6A1639FF")



#----------------------
# Define UI
#----------------------
ui <- fluidPage(useShinyjs(),theme = shinytheme("flatly"),withMathJax(),
  # titlePanel("Influenza Model"),
  tags$head(tags$style(HTML("
  label { font-size: 14px; }
  .form-control { font-size: 12px; }
  .btn { font-size: 14px; }
  h2 { font-size: 14px; }"))),
  sidebarLayout(
    sidebarPanel(width = 4,  # wider sidebar for two columns
                 fluidRow(
                   column(3,
                          h2("Population (per age group)"),
                          numericInput("N_young", "0-19", 20000),
                          numericInput("N_adult", "20-64", 60000),
                          numericInput("N_elderly", "65+", 20000)
                          
                   ),
                   
                      column(3,
  
                          h2("Intervention periods (days)"),
                          numericInput("period1", "Period 1", 25),
                          numericInput("period2", "Period 2", 50),
                          numericInput("period3", "Period 3", 100),
                          
                          h2("Intervention reduction factors"),
                          numericInput("int1", "Period 1 reduction", 0.2),
                          numericInput("int2", "Period 2 reduction", 0.5),
                          numericInput("int3", "Period 3 reduction", 0.7)
                          
                   ),
                   
                   column(3,
                                     
                           h2("Vaccination periods (days)"),
                          numericInput("pervac1", "Period 1", 100),
                          numericInput("pervac2", "Period 2", 150),
                          numericInput("pervac3", "Period 3", 200)
                
                        
                   ),
                   column(3,
                          
                           
                          h2("Vaccination rates (daily) Young"),
                          numericInput("vacc_young1", "Young 0-19, Period 1", 0),
                          numericInput("vacc_young2", "Young 0-19, Period 2", 0),
                          numericInput("vacc_young3", "Young 0-19, Period 3", 0),
                          
                          h2("Vaccination rates (daily) Adult"),
                          numericInput("vacc_adult1", "Adult 20-64, Period 1", 0),
                          numericInput("vacc_adult2", "Adult 20-64, Period 2", 0),
                          numericInput("vacc_adult3", "Adult 20-64, Period 3", 0),
                             h2("Vaccination rates (daily) Elderly"),
                          numericInput("vacc_elderly1", "Elderly 65+, Period 1", 0),
                          numericInput("vacc_elderly2", "Elderly 65+, Period 2", 0),
                          numericInput("vacc_elderly3", "Elderly 65+, Period 3", 0),
                          
                          actionButton("run", "Run Simulation")
                   )
                 )
    ),
    
    
    mainPanel(
      plotOutput("seirPlot",height = "600px"),
      dataTableOutput('TableRed'),
      downloadButton('downloadData', 'Download all data')
   )
  )
)


#----------------------
# Define Server
#----------------------
server <- function(input, output) {
  
  sim_data <- eventReactive(input$run, {
    
    #----------------------
    # Parameters
    #----------------------
    age_groups <- c("young","adult","elderly")
    
    # Contact matrix
    contact_matrix <- matrix(c(
      8,4,1,
      3,6,2,
      1,2,3
    ), nrow=3, byrow=TRUE)
    rownames(contact_matrix) <- age_groups
    colnames(contact_matrix) <- age_groups
    
    # SEIR-HDR parameters
    R0_vec <- c(young = 2.5, adult = 3, elderly = 3.5)
    CFR_vec <- c(young = 0.0001, adult = 0.0003, elderly = 0.02)
    p_hosp_vec <- c(young = 0.01, adult = 0.03, elderly = 0.05)
    p_die_hosp_vec <- c(young = 0.02, adult = 0.25, elderly = 0.5)
    sigma <- 1/2   # incubation rate
    gamma <- 1/5   # recovery rate
    
    # Population
    N_age <- c(young=input$N_young, adult=input$N_adult, elderly=input$N_elderly)
    
    # Beta
    beta_vec <- R0_vec * gamma / rowSums(contact_matrix)
    
    # Initial state
    init_state <- c(
      S_young=as.integer(N_age["young"])-1, E_young=0, I_young=1, H_young=0, R_young=0, D_young=0,
      S_adult=as.integer(N_age["adult"]), E_adult=0, I_adult=0, H_adult=0, R_adult=0, D_adult=0,
      S_elderly=as.integer(N_age["elderly"]),E_elderly=0, I_elderly=0, H_elderly=0, R_elderly=0, D_elderly=0
    )
    
    #----------------------
    # Intervention and Vaccination
    #----------------------
  
    get_intervention_factor <- function(time) {
      if (time < input$period1) {
        return(1.0)    # No intervention
      } else if (time >= input$period1 & time < input$period2) {
        return(input$int1)    # Strong lockdown
      } else if (time >= input$period2 & time < input$period3) {
        return(input$int2)    # Partial reopeningMask wearing
      } else {
        return(input$int3)    # Restrictions lifted
      }
    }

   
    v1 <- as.integer(c(input$vacc_young1,input$vacc_adult1,input$vacc_elderly1))
    v2 <- as.integer(c(input$vacc_young2,input$vacc_adult2,input$vacc_elderly2))
    v3 <- as.integer(c(input$vacc_young3,input$vacc_adult3,input$vacc_elderly3))

    get_vaccination_rate <- function(time) {
      if (time >= input$period1 & time < input$period2) {
        return(c(young = v1[1], adult = v1[2], elderly =v1[3]))  # Elderly only
      } else if (time >= input$period2 & time < input$period3) {
        return(c(young = v2[1], adult = v2[2], elderly =v2[3]))  # Elderly only
      } else if (time >= input$period3) {
        return(c(young = v3[1], adult = v3[2], elderly =v3[3]))  # Elderly only
      } else {
        return(c(young = 0, adult = 0, elderly = 0))  # No vaccination
      }
    }


    #----------------------
    # SEIR-HDR Model
    #----------------------
    seird_model_age <- function(time, state, parameters) {
      with(as.list(state), {
        d_state <- numeric(length(state))
        names(d_state) <- names(state)
        
        I_vec <- sapply(age_groups, function(age) state[paste0("I_", age)])
        contact_matrix_eff <- contact_matrix * get_intervention_factor(time)
        lambda <- sapply(1:3, function(j) sum(contact_matrix_eff[j, ] * I_vec / N_age))
        vac_rates <- get_vaccination_rate(time)
        
        for (i in 1:3) {
          age <- age_groups[i]
          S <- state[paste0("S_", age)]
          E <- state[paste0("E_", age)]
          I <- state[paste0("I_", age)]
          H <- state[paste0("H_", age)]
          
          CFR <- CFR_vec[age]
          beta <- beta_vec[age]
          p_hosp <- p_hosp_vec[age]
          p_die_hosp <- p_die_hosp_vec[age]
          
          mu <- p_die_hosp / 10
          rho <- (1 - p_die_hosp) / 10
          
          vac <- min(S, vac_rates[age])  # daily vaccinations
          
          dS <- -beta * S * lambda[i] - vac
          dE <-  beta * S * lambda[i] - sigma * E
          dI <-  sigma * E - gamma * I
          dH <- p_hosp * gamma * I - (rho + mu) * H
          dR <- (1 - p_hosp) * gamma * I + rho * H + vac
          dD <- CFR * gamma * I + mu * H
          
          d_state[paste0("S_", age)] <- dS
          d_state[paste0("E_", age)] <- dE
          d_state[paste0("I_", age)] <- dI
          d_state[paste0("H_", age)] <- dH
          d_state[paste0("R_", age)] <- dR
          d_state[paste0("D_", age)] <- dD
        }
        
        return(list(d_state))
      })
    }
    

    
    time <- seq(0, 300, by = 1)
    out <-  as.data.frame(ode(y = init_state, times = time, func = seird_model_age, parms = NULL))

dt_d <- out[, c(1,grep("D_", names(out)))] %>%
  gather(., comp, prop,2:4) 

dt_i <- out[, c(1,grep("I_", names(out)))] %>%
  gather(., comp, prop,2:4) 

dt_h <- out[, c(1,grep("H_", names(out)))] %>%
  gather(., comp, prop,2:4) 

dt_pop <- data.frame(N_age) %>%
  mutate(
    age =row.names(.)) %>%
  rename(pop = N_age)

dt <- rbind(dt_d, dt_h, dt_i) %>%
  mutate(
    age = str_sub(comp, 3),
    age = as.factor(age),
    fac = str_sub(comp,1, 1),
    fac = as.factor(fac)
  ) %>%
  mutate(
    fac = case_when(fac == "D" ~ "Deceased",
                    fac == "I" ~ "Infected",
                    fac == "H" ~ "Hospitalisation"),
    fac  = factor(fac , levels=c("Infected","Hospitalisation","Deceased")),
  ) %>%
  left_join(dt_pop) %>%
  mutate(
    mx = prop/pop *100000
  )

dts <- dt %>%
  select(Day = time, Age=age, Pop=pop, Event=fac, Absolute=prop, Relative=mx) %>%
  mutate(Absolute= round(Absolute),
         Relative = round(Relative))

# print(dts)

  })
  
 
  #----------------------
  # Plot
  #----------------------
  output$seirPlot <- renderPlot({
    ggplot(sim_data(), aes(x = Day)) +
      facet_wrap(~ Event, ncol=3, scales = "free_y") +
      geom_line(aes(y = Absolute, color = Age), lwd=3) +
      labs(
           x = "Days",
           y = "Individuals")+
      scale_color_manual("",
                         breaks=c("young","adult","elderly"),
                         labels=c("0-18","19-64",">=65"),
                         values = col_a) +
      # scale_y_continuous(breaks = seq(0, 100000, by = 10000)) +
      theme_bw() +
      theme(
        strip.text = element_text(size=20),
        axis.text = element_text(size=20),
        axis.title  = element_text(size=20),
        legend.position = "bottom",
        legend.text=element_text(size=20),
        plot.title = element_text(size=20),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
  })
  
      
dtta <- reactive({ 
  dtta <- sim_data() %>%
    filter(Day %in% c(25, 50,100, 200))
  return(dtta )
})

  
  output$TableRed <- renderDataTable({
    datatable(dtta() ,options = list(bFilter=0))
  })
  
  
  # #----------------------
  # # Download
  # #----------------------
  output$downloadData <- downloadHandler(
    filename = function() { paste("simulation_data","xlsx",sep=".") },
    content = function(file) { write.xlsx(sim_data(), file, row.names=FALSE) }
  )
  
  
  
}

#----------------------
# Run App
#----------------------
shinyApp(ui = ui, server = server,options = list(height = 1000,width=2000))
```

